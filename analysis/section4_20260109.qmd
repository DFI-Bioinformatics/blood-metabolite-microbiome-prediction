---
title: "Longitudinal Analysis"
format: html
editor: visual
---

```{r}

library(tidyverse)
library(here)
library(patchwork)
library(missForest)
library(tidymodels)
library(ggpubr)
library(rstatix)
library(vegan)
library(progress)

```

```{r}


get_importance <- function(x) {
  vip::vi(extract_fit_parsnip(x))
}

rf_reg_vfold = function(df, workflow, n_folds = 5, seed_value = 333)
{

  set.seed(seed_value)
  cv_folds = vfold_cv(df, v = n_folds)
  
  cv_results = fit_resamples(
    workflow,
    resamples = cv_folds,
    metrics = metric_set(rmse, rsq, mae),
    control = control_resamples(
      save_pred = T, 
      save_workflow = T,
      extract = get_importance
      )
    )

  df_pred = cv_results %>%
    collect_predictions() %>%
    bind_cols(
      df %>% select(sample_id) %>% slice(cv_results %>% collect_predictions() %>% pull(.row))
    )

  df_imp = cv_results %>%
    select(id, .extracts) %>%
    unnest(cols = .extracts) %>%
    unnest(cols = .extracts) %>%
    group_by(Variable) %>%
    mutate(
      mean_importance = mean(Importance),
      sd_importance = sd(Importance)
    ) %>%
    ungroup() |> 
    arrange(desc(mean_importance))
  
  df_metrics = collect_metrics(cv_results, summarize = F) |> 
    group_by(.metric) |> 
    mutate(mean = mean(.estimate), sd = sd(.estimate)) |> 
    ungroup()
  
  return(list(
    'df_metrics' = df_metrics, 
    'df_pred' = df_pred, 
    'df_imp' = df_imp
    ))
}


plot_pred_act_vfold_reg = function(res, col = NULL, folds_col_map = NULL, fill = NULL)
{
  range_vals <- range(c(res$df_pred$y, res$df_pred$.pred))

  if(!is.null(folds_col_map))
  {
  p = res$df_pred %>%
    ggplot(aes(x = y, y = .pred, fill = id)) +
    geom_point(size = 3, pch = 21) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +
    labs(x = "Actual Shannon Diversity", y = "Predicted Shannon Diversity") +
    annotate("text", 
             x = min(range_vals) + diff(range_vals) * 0.05,
             y = max(range_vals) - diff(range_vals) * 0.05,
             label = sprintf("R² = %.2f ± %.2f", 
                             res$df_metrics[res$df_metrics$.metric == 'rsq',]$mean[1], 
                             res$df_metrics[res$df_metrics$.metric == 'rsq',]$sd[1]),
             hjust = .1, vjust = .5) +
    scale_x_continuous(limits = range(c(res$df_pred$y, res$df_pred$.pred)), expand = expansion(mult = 0.05)) +
    scale_y_continuous(limits = range(c(res$df_pred$y, res$df_pred$.pred)), expand = expansion(mult = 0.05)) +
    theme_bw(base_size = 15) +
    theme(
      legend.position = c(0.95, 0.05),
      legend.justification = c(1, 0),
      legend.background = element_rect(fill = "white", color = "gray70", linewidth = 0.3)
  ) +
    scale_fill_manual(values = folds_col_map, name = "Fold")
  }
  
  if(!is.null(fill))
  {
    p = res$df_pred %>%
      ggplot(aes(x = y, y = .pred)) +
      geom_point(size = 3, pch = 21, fill = fill) +
      geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +
      labs(x = "Actual Shannon Diversity", y = "Predicted Shannon Diversity") +
      annotate("text", 
               x = min(range_vals) + diff(range_vals) * 0.05,
               y = max(range_vals) - diff(range_vals) * 0.05,
               label = sprintf("R² = %.2f ± %.2f", 
                               res$df_metrics[res$df_metrics$.metric == 'rsq',]$mean[1], 
                               res$df_metrics[res$df_metrics$.metric == 'rsq',]$sd[1]),
               hjust = .1, vjust = .5) +
      scale_x_continuous(limits = range(c(res$df_pred$y, res$df_pred$.pred)), expand = expansion(mult = 0.05)) +
      scale_y_continuous(limits = range(c(res$df_pred$y, res$df_pred$.pred)), expand = expansion(mult = 0.05)) +
      theme_bw(base_size = 15) +
      theme(
        legend.position = c(0.95, 0.05),
        legend.justification = c(1, 0),
        legend.background = element_rect(fill = "white", color = "gray70", linewidth = 0.3)
    )
  }
  
  if(!is.null(col))
  {
    p = res$df_pred %>%
      ggplot(aes(x = y, y = .pred)) +
      geom_point(size = 3, pch = 21, col = col) +
      geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
      labs(x = "Actual Shannon Diversity", y = "Predicted Shannon Diversity") +
      annotate("text", 
               x = min(range_vals) + diff(range_vals) * 0.05,
               y = max(range_vals) - diff(range_vals) * 0.05,
               label = sprintf("R² = %.2f ± %.2f", 
                               res$df_metrics[res$df_metrics$.metric == 'rsq',]$mean[1], 
                               res$df_metrics[res$df_metrics$.metric == 'rsq',]$sd[1]),
               hjust = .1, vjust = .5) +
      scale_x_continuous(limits = range(c(res$df_pred$y, res$df_pred$.pred)), expand = expansion(mult = 0.05)) +
      scale_y_continuous(limits = range(c(res$df_pred$y, res$df_pred$.pred)), expand = expansion(mult = 0.05)) +
      theme_bw(base_size = 15) +
      theme(
        legend.position = c(0.95, 0.05),
        legend.justification = c(1, 0),
        legend.background = element_rect(fill = "white", color = "gray70", linewidth = 0.3)
    )
  }
  
  
  return(p)
}


rf_class_vfold <- function(df, workflow, n_folds = 5, seed_value = 333) {
  set.seed(seed_value)
  cv_folds <- vfold_cv(df, v = n_folds)
  
  model_spec <- extract_spec_parsnip(workflow)
  metrics = metric_set(roc_auc, accuracy, sensitivity, specificity)
  
  get_importance_universal <- function(x) {
    model <- extract_fit_parsnip(x)
    
    imp <- tryCatch({
      vip::vi(model)
    }, error = function(e) {
      tryCatch({
        tidy(model) %>%
          filter(term != "(Intercept)") %>%
          mutate(Importance = abs(estimate)) %>%
          select(Variable = term, Importance)
      }, error = function(e) {
        NULL
      })
    })
    return(imp)
  }
  
  cv_results <- fit_resamples(
    workflow,
    resamples = cv_folds,
    metrics = metrics,
    control = control_resamples(
      save_pred = TRUE, 
      save_workflow = TRUE,
      extract = get_importance_universal
    )
  )
  
  df_pred <- cv_results %>%
    collect_predictions() %>%
    bind_cols(
      df %>% select(sample_id) %>% slice(cv_results %>% collect_predictions() %>% pull(.row))
    )
  
  df_imp <- tryCatch({
    cv_results %>%
      select(id, .extracts) %>%
      unnest(cols = .extracts) %>%
      unnest(cols = .extracts) %>%
      filter(!is.null(Variable))
  }, error = function(e) NULL)
  
  df_metrics <- collect_metrics(cv_results, summarize = FALSE) %>%
    group_by(.metric) %>%
    mutate(mean = mean(.estimate), sd = sd(.estimate)) %>%
    ungroup()
  
  return(list(
    'df_metrics' = df_metrics, 
    'df_pred' = df_pred, 
    'df_imp' = df_imp,
    'cv_results' = cv_results
  ))
}



```

```{r}

cohort_colors = c(
  'AML' = '#D55E00',
  'MICU' = '#7876B1FF',
  'Healthy' = '#009E73'
)

families_of_interest = c(
  'Lachnospiraceae', 
  'Oscillospiraceae', 
  'Bacteroidaceae'
  ) 

taxa_family_colors = c(
  'Enterococcaceae' = "#129246", 
  'Enterobacteriaceae' = "red", 
  'Lachnospiraceae' = "#EC9B96", 
  'Oscillospiraceae' = "#9AAE73", 
  'Bacteroidaceae' = "#51AB9B"
)

selected_commensals = c('Lachnospiraceae', 'Oscillospiraceae', 'Bacteroidaceae')

```

# Prep Data

```{r}


df_meta = read.csv(here('data', 'df_meta.csv'))
df_meta_qual = read.csv(here('data', 'df_meta_qual.csv'))
df_meta_mp = read.csv(here('data', 'df_meta_mp.csv'))
df_meta_quant = read.csv(here('data', 'df_meta_quant.csv'))

df_mp = read.csv(here('data', 'df_mp.csv')) |> filter(statq == 'statq_0.20')

mat_qual_fecal = read.csv(here('data', 'AML_fecal', 'mat_qual_fecal.csv')) |> column_to_rownames('X') |> as.matrix()
mat_qual_plasma = read.csv(here('data', 'AML_plasma', 'mat_qual_plasma.csv')) |> column_to_rownames('X') |> as.matrix()

mat_quant_fecal = read.csv(here('data', 'AML_fecal', 'mat_quant_fecal.csv')) |> column_to_rownames('X') |> as.matrix()
mat_quant_plasma = read.csv(here('data', 'AML_plasma', 'mat_quant_plasma.csv')) |> column_to_rownames('X') |> as.matrix()


mat_qual_plasma = as.data.frame(mat_qual_plasma) |> 
  rownames_to_column('sample_id') |> 
  select(-QUAL074) |> 
  left_join(
    rbind(
      read.csv(here('data', 'AML_plasma', 'normalized_results_20251217_isoUDCA_MDCA_AMLplasma.csv'), check.names = F),
      read.csv(here('data', 'AML_plasma', 'normalized_results_isoUDCA_MDCA_AML00112_AML00307.csv'), check.names = F)
      ) |>  
      mutate(sampleid = gsub('\\.', '', sampleid)) |> 
      left_join(df_meta |> select(sampleid = metabolomics_id_plasma, sample_id), by = 'sampleid') |> 
      select(-sampleid) |> 
      rename_with(~ case_when(
        .x == "isoursodeoxycholic acid"  ~ "QUAL074_1",
        .x == "murideoxycholic acid"  ~ "QUAL074_2",
        T ~ .x
      )) |> 
      mutate(QUAL074_1 = ifelse(is.na(QUAL074_1), 0, QUAL074_1)) |>
      mutate(QUAL074_2 = ifelse(is.na(QUAL074_2), 0, QUAL074_2)),
    by = 'sample_id'
    ) |> 
  column_to_rownames('sample_id') |> 
  as.matrix()



mat_qual_fecal = as.data.frame(mat_qual_fecal) |> 
  rownames_to_column('sample_id') |> 
  select(-QUAL074) |> 
  left_join(
    read.csv(here('data', 'AML_fecal', 'normalized_results_20251221_isoUDCA_MDCA_AMLfecal.csv'), check.names = F) |>  
      mutate(sampleid = gsub('\\.', '', sampleid)) |> 
      left_join(df_meta |> select(sampleid = metabolomics_id_fecal, sample_id), by = 'sampleid') |> 
      select(-sampleid) |> 
      rename_with(~ case_when(
        .x == "isoursodeoxycholic acid"  ~ "QUAL074_1",
        .x == "murideoxycholic acid"  ~ "QUAL074_2",
        T ~ .x
      )) |> 
      mutate(QUAL074_1 = ifelse(is.na(QUAL074_1), 0, QUAL074_1)) |>
      mutate(QUAL074_2 = ifelse(is.na(QUAL074_2), 0, QUAL074_2)),
    by = 'sample_id'
    ) |> 
  column_to_rownames('sample_id') |> 
  as.matrix()

```

```{r}


mat_mps = df_mp |> 
  filter(seq_id %in% df_meta$seq_id) |> 
  left_join(df_meta |> select(sample_id, seq_id), by = 'seq_id') |> 
  select(sample_id, species, ra) |> 
  pivot_wider(id_cols = sample_id, names_from = species, values_from = ra, values_fill = 0) |> 
  column_to_rownames('sample_id') |> 
  as.matrix()

mat_mpg = mat_mps |> 
  as.data.frame() |> 
  rownames_to_column('sample_id') |> 
  pivot_longer(!sample_id, names_to = 'species', values_to = 'ra') |> 
  left_join(df_meta_mp, by = 'species') |> 
  
  group_by(sample_id, genus) |> 
  summarize(ra = sum(ra), .groups = 'drop') |> 
  ungroup() |> 
  
  pivot_wider(id_cols = sample_id, names_from = genus, values_from = ra, values_fill = 0) |> 
  column_to_rownames('sample_id') |> 
  as.matrix()

mat_mpf = mat_mps |> 
  as.data.frame() |> 
  rownames_to_column('sample_id') |> 
  pivot_longer(!sample_id, names_to = 'species', values_to = 'ra') |> 
  left_join(df_meta_mp, by = 'species') |> 
  
  group_by(sample_id, family) |> 
  summarize(ra = sum(ra), .groups = 'drop') |> 
  ungroup() |> 
  
  pivot_wider(id_cols = sample_id, names_from = family, values_from = ra, values_fill = 0) |> 
  column_to_rownames('sample_id') |> 
  as.matrix()

mat_mpo = mat_mps |> 
  as.data.frame() |> 
  rownames_to_column('sample_id') |> 
  pivot_longer(!sample_id, names_to = 'species', values_to = 'ra') |> 
  left_join(df_meta_mp, by = 'species') |> 
  
  group_by(sample_id, order) |> 
  summarize(ra = sum(ra), .groups = 'drop') |> 
  ungroup() |> 
  
  pivot_wider(id_cols = sample_id, names_from = order, values_from = ra, values_fill = 0) |> 
  column_to_rownames('sample_id') |> 
  as.matrix()

mat_mpc = mat_mps |> 
  as.data.frame() |> 
  rownames_to_column('sample_id') |> 
  pivot_longer(!sample_id, names_to = 'species', values_to = 'ra') |> 
  left_join(df_meta_mp, by = 'species') |> 
  
  group_by(sample_id, class) |> 
  summarize(ra = sum(ra), .groups = 'drop') |> 
  ungroup() |> 
  
  pivot_wider(id_cols = sample_id, names_from = class, values_from = ra, values_fill = 0) |> 
  column_to_rownames('sample_id') |> 
  as.matrix()

mat_mpp = mat_mps |> 
  as.data.frame() |> 
  rownames_to_column('sample_id') |> 
  pivot_longer(!sample_id, names_to = 'species', values_to = 'ra') |> 
  left_join(df_meta_mp, by = 'species') |> 
  
  group_by(sample_id, phylum) |> 
  summarize(ra = sum(ra), .groups = 'drop') |> 
  ungroup() |> 
  
  pivot_wider(id_cols = sample_id, names_from = phylum, values_from = ra, values_fill = 0) |> 
  column_to_rownames('sample_id') |> 
  as.matrix()


```

```{r}

mat_alphadiv = data.frame(
  shannon = diversity(mat_mps, index = "shannon"),
  shannon_genus = diversity(mat_mpg, index = "shannon"),
  inv_simpson = diversity(mat_mps, index = "invsimpson"),
  richness = specnumber(mat_mps)
) |> 
  as.matrix()


```

```{r}


matrices_names = c(
  'mat_mps', 'mat_mpg', 'mat_mpf', 'mat_mpo', 'mat_mpc', 'mat_mpp',
  'mat_quant_plasma', 'mat_quant_fecal', 'mat_qual_fecal', 'mat_qual_plasma', 'mat_alphadiv'
  )

matrices = mget(matrices_names)
common_rows = Reduce(intersect, lapply(matrices, rownames)) 
matrices = lapply(matrices, function(m) m[common_rows, ])
list2env(setNames(matrices, matrices_names), envir = .GlobalEnv)

df_meta = df_meta[match(rownames(get(matrices_names[1])), df_meta$sample_id), ]
df_mp = df_mp |> filter(seq_id %in% df_meta$seq_id)

```

```{r}

seed_value = 333
n_folds = 5

pseudo_mat_qual_fecal = min(mat_qual_fecal[mat_qual_fecal > 0], na.rm = T)*0.1
pseudo_mat_qual_plasma = min(mat_qual_plasma[mat_qual_plasma > 0], na.rm = T)*0.1

```

# Figure

```{r}


reg_rf_spec = rand_forest(
  mtry = floor(sqrt(ncol(X))),
  min_n = 5,
  trees = 500
  ) %>%
  set_engine("ranger", importance = "permutation") %>%
  set_mode("regression")


selected_features  = c(
  'QUAL016', # IPA
  'QUAL074_1', # isoUDCA
  "QUAL072", # isoDCA
  "QUAL138", # isoCDCA
  "QUAL058", # DCA
  "QUAL065", # GDCA
  "QUAL137", # GLCA-3S
  "QUAL063" # GCA
  )

X = apply(mat_qual_plasma, 2, function(x) log10(x + pseudo_mat_qual_plasma))
X = X[, selected_features]

y = df_meta$shannon
group = df_meta$study_id

df = as.data.frame(X) |> 
  rownames_to_column('sample_id') |> 
  mutate(y = y, group = group)

recipe = recipe(y ~ ., data = df) |> 
  update_role(sample_id, new_role = "sample_id") |> 
  update_role(group, new_role = "group") |> 
  step_normalize(all_predictors()) 

workflow = workflow() |> add_recipe(recipe)

res_rfreg_vfold_aml_reduced = rf_reg_vfold(df, workflow |> add_model(reg_rf_spec), n_folds=5, seed_value = 333)

```

```{r}


class_rf_spec = rand_forest(
  mtry = floor(sqrt(ncol(X))),
  min_n = 5,
  trees = 500
) %>%
  set_engine("ranger", importance = "permutation") %>%
  set_mode("classification")



X = apply(mat_qual_plasma, 2, function(x) log10(x + pseudo_mat_qual_plasma))

Y = ifelse(mat_mpf > 0, 1, 0)
Y = Y[, colSums(Y) != 0 & colSums(Y) != nrow(Y)]
Y = Y[, colSums(Y == 0) <= 184 & colSums(Y == 1) <= 184] # At least 10 samples with differnt values

pb = progress_bar$new(format = "[:bar] :percent  (:current/:total) ETA::eta", total = ncol(Y), clear = F, width = 60)
res_rfclass_vfold_aml_mpf = list()
res_xgbclass_vfold_aml_mpf= list()
res_ridgeclass_vfold_aml_mpf = list()
res_lassoclass_vfold_aml_mpf = list()

for(col in c('Lachnospiraceae', 'Oscillospiraceae', 'Bacteroidaceae'))
{
  pb$tick()
  y = Y[, col]
  y = factor(ifelse(y == 1, 'Present', 'Absent'), levels = c('Present', 'Absent'))
  
  df = as.data.frame(X) |>rownames_to_column('sample_id') |> mutate(y = y)

  recipe = recipe(y ~ ., data = df) |> 
    update_role(sample_id, new_role = "sample_id") |> 
    step_normalize(all_predictors()) 

  workflow = workflow() |> add_recipe(recipe)
  
  res_rfclass_vfold_aml_mpf[[col]] = rf_class_vfold(df, workflow |> add_model(class_rf_spec), 5, 333)
}


```

```{r}

selected_patients = c('AML-002', 'AML-007')

source(here("R_scripts", "getRdpPal.R"))


df_meta_combined = df_meta |> 
  select(sample_id, seq_id, study_id, shannon, inv_simpson, richness, timeline_collected) |> mutate(type = 'AML') |>        
  mutate(shannon = as.numeric(shannon))

df_mp_combined = df_mp |> 
  rename(Kingdom = kingdom, Phylum = phylum, Class = class, Order = order, Family = family, Genus = genus) |> 
  mutate(genLab = Genus, Genus = paste0(Phylum,"-",Order,"-", Family, "-",Genus)) 

taxpalm = getRdpPal(df_mp_combined)

lvls = df_meta_combined |> 
  filter(study_id %in% selected_patients) |> 
  group_by(study_id, sample_id) |> 
  arrange(timeline_collected) |> 
  ungroup() |> 
  mutate(sample_id_reordered = factor(paste(sample_id, study_id, sep = "__"), levels = paste(sample_id, study_id, sep = "__"))) |>
  select(sample_id, sample_id_reordered, timeline_collected)

p1 = df_mp_combined %>%
  arrange(Kingdom, Phylum, Class, Order, Family, Genus, genLab) %>%
  group_by(seq_id) %>%
  arrange(Genus) %>%
  ungroup() %>%
  left_join(df_meta_combined %>% select(seq_id, sample_id, study_id, shannon)) %>% 
  filter(study_id %in% selected_patients) |> 
  left_join(lvls, by = 'sample_id') |> 
  ggplot(aes(x = sample_id_reordered, y = ra)) +
  geom_bar(aes(fill = Genus), stat = "identity") +
  scale_fill_manual(values = taxpalm) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(), 
    axis.ticks.x = element_blank(),
    legend.position = "none"
    ) +
  scale_x_discrete(
    guide = guide_axis(angle = 60),,
    labels = function(x) gsub("__.+$", "", x)
    ) +
  scale_y_continuous(limits=c(0, 1.02)) +
  facet_grid(.~study_id, scales = 'free_x', space = 'free_x') +
  labs(y = "Relative Abundance", x = NULL) 

```

```{r}

p2 = df_meta_combined |> 
  filter(study_id %in% selected_patients) |> 
  left_join(lvls, by = 'sample_id') |> 
  ggplot(aes(x = sample_id_reordered, y = shannon)) +
  geom_col(fill = '#4A4A4A') +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text.x.top = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = 'none'
    ) +
  scale_x_discrete(
    guide = guide_axis(angle = 60),
    labels = function(x) gsub("__.+$", "", x)
    ) +
  facet_grid(.~study_id, scales = 'free_x', space = 'free_x') +
  labs(x = "", y = "Shannon Act") +
  ylim(0,4)

p3 = df_meta_combined |> 
  left_join(res_rfreg_vfold_aml_reduced$df_pred |> select(sample_id, shannon_pred = .pred), by = 'sample_id') |> 
  filter(study_id %in% selected_patients) |> 
  left_join(lvls, by = 'sample_id') |> 
  ggplot(aes(x = sample_id_reordered, y = shannon_pred)) +
  geom_col(fill = cohort_colors['AML']) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text.x.top = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = 'none'
    ) +
  scale_x_discrete(
    guide = guide_axis(angle = 60),
    labels = function(x) gsub("__.+$", "", x)
    ) +
  labs(x = "", y = "Shannon Pred") +
  facet_grid(.~study_id, scales = 'free_x', space = 'free_x') +
  ylim(0,4)

```

```{r}

df_p_tax = map_dfr(selected_commensals, function(taxa) {
  res_rfclass_vfold_aml_mpf[[taxa]]$df_pred |> mutate(taxa = taxa)
}) |> 
  mutate(taxa = factor(taxa, levels = families_of_interest)) |> 
  select(taxa, sample_id, Predicted = .pred_class, Actual = y)

p4 = df_p_tax |> 
  left_join(df_meta_combined, by = 'sample_id') |> 
  filter(study_id %in% selected_patients) |> 
  left_join(lvls, by = 'sample_id') |> 
  filter(taxa == 'Lachnospiraceae') |> 
  select(study_id, sample_id_reordered, Predicted, Actual) |> 
  pivot_longer(-c(sample_id_reordered, study_id), names_to = 'var', values_to = 'val') |> 
  mutate(var = factor(var, levels = c('Predicted', 'Actual'))) |>  
  ggplot(aes(x = sample_id_reordered, y = var, fill = val)) +
  geom_tile() +
  scale_fill_manual(values = c('Present' = '#EC9B96', 'Absent' = 'white')) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text.x.top = element_blank(),
    strip.text.y.right = element_text(angle = 0),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = 'none'
    ) +
  facet_grid(.~study_id, scales = 'free_x', space = 'free_x') +
  labs(x = "", y = "", fill = 'RA')

p5 = df_p_tax |> 
  left_join(df_meta_combined, by = 'sample_id') |> 
  filter(study_id %in% selected_patients) |> 
  left_join(lvls, by = 'sample_id') |> 
  filter(taxa == 'Oscillospiraceae') |> 
  select(study_id, sample_id_reordered, Predicted, Actual) |> 
  pivot_longer(-c(sample_id_reordered, study_id), names_to = 'var', values_to = 'val') |> 
  mutate(var = factor(var, levels = c('Predicted', 'Actual'))) |>  
  ggplot(aes(x = sample_id_reordered, y = var, fill = val)) +
  geom_tile() +
  scale_fill_manual(values = c('Present' = '#9AAE73', 'Absent' = 'white')) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text.x.top = element_blank(),
    strip.text.y.right = element_text(angle = 0),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = 'none'
    ) +
  facet_grid(.~study_id, scales = 'free_x', space = 'free_x') +
  labs(x = "", y = "", fill = 'RA')

p6 = df_p_tax |> 
  left_join(df_meta_combined, by = 'sample_id') |> 
  filter(study_id %in% selected_patients) |> 
  left_join(lvls, by = 'sample_id') |> 
  filter(taxa == 'Bacteroidaceae') |> 
  select(study_id, sample_id_reordered, Predicted, Actual) |> 
  pivot_longer(-c(sample_id_reordered, study_id), names_to = 'var', values_to = 'val') |> 
  mutate(var = factor(var, levels = c('Predicted', 'Actual'))) |>  
  ggplot(aes(x = sample_id_reordered, y = var, fill = val)) +
  geom_tile() +
  scale_fill_manual(values = c('Present' = '#51AB9B', 'Absent' = 'white')) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text.x.top = element_blank(),
    strip.text.y.right = element_text(angle = 0),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = 'none'
    ) +
  facet_grid(.~study_id, scales = 'free_x', space = 'free_x') +
  labs(x = "", y = "", fill = 'RA')

```

```{r}


# x_labels = lvls |> 
#   distinct(sample_id_reordered, timeline_collected) |> 
#   tibble::deframe()
# 
# p7 = as.data.frame(mat_qual_plasma) |> 
#   rownames_to_column('sample_id') |> 
#   pivot_longer(!sample_id, names_to = 'compound_id', values_to = 'value') |> 
#   left_join(df_meta, by = 'sample_id') |> 
#   left_join(df_meta_qual |> select(compound_id, compound), by = 'compound_id') |> 
#   left_join(lvls, by = 'sample_id') |> 
#   filter(study_id %in% selected_patients) |> 
#   #filter(compound_id %in% selected_features) |> 
#   filter(compound %in% c('IPA', 'isoCDCA', 'GCA')) |> 
#   mutate(compound = factor(compound, levels = c('IPA', 'isoCDCA', 'GCA'))) |> 
#   select(study_id, sample_id, sample_id_reordered, compound, value) |> 
#   group_by(compound) |> 
#   mutate(value_norm = log10(value + min(value[value>0], na.rm = T)*0.1)) |> 
#   ggplot(aes(x = sample_id_reordered, y = value_norm, color = compound, group = 1)) +
#   geom_point() +
#   geom_line() +
#   scale_color_manual(values = c('IPA' = '#56B4E9', 'isoCDCA' = '#882255', 'GCA' = '#E69F00')) +
#   scale_x_discrete(labels = x_labels, guide = guide_axis(angle = 60)) +
#   facet_wrap(~compound, scales = 'free_y', ncol = 1) +
#   theme_bw(base_size = 12) +
#   theme(
#     strip.text.x.top = element_blank(),
#     strip.text.y.right = element_text(angle = 0),
#     panel.grid.minor = element_blank(),
#     panel.grid.major = element_blank(),
#     legend.position = 'none'
#     ) +
#   facet_grid(compound ~ study_id, scales = 'free_x', space = 'free_x') +
#   labs(x = 'Samples Ordered by Collection Day', y = 'log10( Normalized Peak Area)') 


```

```{r fig.width = 10, fig.height=10}

pdf(here('output', paste0('fig4a_', format(Sys.Date(), "%Y%m%d"), '.pdf')), height = 8, width = 8)
(p1 / p2 / p3 / p4 / p5 / p6) + plot_layout(heights = c(6,2,2,1,1,1,6))
dev.off()

```

```{r}





```

# Supplemental

```{r}

# Fecal and plasma trends

x_labels = lvls |> 
  distinct(sample_id_reordered, timeline_collected) |> 
  tibble::deframe()

df_p = rbind(
  as.data.frame(mat_qual_plasma) |> 
    rownames_to_column('sample_id') |> 
    pivot_longer(!sample_id, names_to = 'compound_id', values_to = 'value') |> 
    left_join(df_meta, by = 'sample_id') |> 
    left_join(df_meta_qual |> select(compound_id, compound), by = 'compound_id') |> 
    left_join(lvls, by = 'sample_id') |> 
    filter(study_id %in% selected_patients) |> 
    filter(compound_id %in% selected_features) |> 
    select(study_id, sample_id, sample_id_reordered, compound, value) |> 
    group_by(compound) |> 
    mutate(value_norm = log10(value + min(value[value>0], na.rm = T)*0.1)) |> 
    mutate(type = 'Plasma Qual'),
  as.data.frame(mat_qual_fecal) |> 
    rownames_to_column('sample_id') |> 
    pivot_longer(!sample_id, names_to = 'compound_id', values_to = 'value') |> 
    left_join(df_meta, by = 'sample_id') |> 
    left_join(df_meta_qual |> select(compound_id, compound), by = 'compound_id') |> 
    left_join(lvls, by = 'sample_id') |> 
    filter(study_id %in% selected_patients) |> 
    filter(compound_id %in% selected_features) |> 
    select(study_id, sample_id, sample_id_reordered, compound, value) |> 
    group_by(compound) |> 
    mutate(value_norm = log10(value + min(value[value>0], na.rm = T)*0.1)) |> 
    mutate(type = 'Fecal Qual')
)
  

p_s4a = df_p |> 
  ggplot(aes(x = sample_id_reordered, y = value_norm, color = type, shape = type, group = type)) +
  geom_point(alpha = .7) +
  geom_line() +
  scale_x_discrete(labels = x_labels, guide = guide_axis(angle = 60)) +
  facet_wrap(~compound, scales = 'free_y', ncol = 1) +
  theme_bw(base_size = 12) +
  theme(
    strip.text.y.right = element_text(angle = 0),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    legend.position = 'bottom'
    ) +
  facet_grid(compound ~ study_id, scales = 'free_x', space = 'free_x') +
  labs(x = 'Samples Ordered by Collection Day', y = 'log10( Normalized Peak Area)') 


```

```{r}

pdf(here('output', paste0('figS4a_', format(Sys.Date(), "%Y%m%d"), '.pdf')), height = 8, width = 8)
p_s4a
dev.off()

```
